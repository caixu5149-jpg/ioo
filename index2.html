<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èº«å¿ƒç–—æ„ˆç«™ Pro</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- å¼•å…¥ Babel ç”¨äºè§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è‡ªå®šä¹‰åŠ¨ç”»æ ·å¼ -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-in {
            animation-duration: 0.3s;
            animation-fill-mode: forwards;
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- 0. å›¾æ ‡ç»„ä»¶ (æ›¿ä»£ Lucide-React) ---
        const IconWrapper = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Wind = (props) => <IconWrapper {...props}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const Activity = (props) => <IconWrapper {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
        const Play = (props) => <IconWrapper {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconWrapper>;
        const ArrowLeft = (props) => <IconWrapper {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;
        const Settings = (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const Volume2 = (props) => <IconWrapper {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></IconWrapper>;
        const VolumeX = (props) => <IconWrapper {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></IconWrapper>;
        const Zap = (props) => <IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>;
        const Share2 = (props) => <IconWrapper {...props}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></IconWrapper>;
        const Flame = (props) => <IconWrapper {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a1 1 0 0 1 1.9.8z"/></IconWrapper>;
        const Sliders = (props) => <IconWrapper {...props}><line x1="4" x2="4" y1="21" y2="14"/><line x1="4" x2="4" y1="10" y2="3"/><line x1="12" x2="12" y1="21" y2="12"/><line x1="12" x2="12" y1="8" y2="3"/><line x1="20" x2="20" y1="21" y2="16"/><line x1="20" x2="20" y1="12" y2="3"/><line x1="2" x2="6" y1="14" y2="14"/><line x1="10" x2="14" y1="8" y2="8"/><line x1="18" x2="22" y1="16" y2="16"/></IconWrapper>;
        const Trophy = (props) => <IconWrapper {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconWrapper>;
        const RefreshCw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>;

        // --- 1. åŸºç¡€è®¾æ–½ (Hooks & Utils) ---

        const formatTime = (seconds) => {
            if (isNaN(seconds)) return "00:00";
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        // éŸ³æ•ˆç®¡ç†å™¨ (å•ä¾‹æ¨¡å¼)
        const useSound = (enabled) => {
            const audioCtxRef = useRef(null);

            const getCtx = () => {
                if (!audioCtxRef.current) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (AudioContext) audioCtxRef.current = new AudioContext();
                }
                return audioCtxRef.current;
            };

            const playTone = useCallback((type) => {
                if (!enabled) return;
                const ctx = getCtx();
                if (!ctx) return;
                if (ctx.state === 'suspended') ctx.resume();

                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();
                osc.connect(gainNode);
                gainNode.connect(ctx.destination);
                const now = ctx.currentTime;

                if (type === 'bell') { 
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(520, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 2.5);
                    gainNode.gain.setValueAtTime(0.15, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 2.5);
                    osc.start(now);
                    osc.stop(now + 2.5);
                } else if (type === 'tick') { 
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(800, now);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'breath_in') { 
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(220, now);
                    osc.frequency.linearRampToValueAtTime(330, now + 3);
                    gainNode.gain.setValueAtTime(0.02, now);
                    gainNode.gain.linearRampToValueAtTime(0.08, now + 3);
                    osc.start(now);
                    osc.stop(now + 3);
                } else if (type === 'unlock') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.setValueAtTime(554, now + 0.1);
                    osc.frequency.setValueAtTime(659, now + 0.2);
                    gainNode.gain.setValueAtTime(0.1, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
                    osc.start(now);
                    osc.stop(now + 0.6);
                }
            }, [enabled]);

            return { playTone };
        };

        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { return initialValue; }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) { console.error(error); }
            };
            return [storedValue, setValue];
        };

        const useInterval = (callback, delay) => {
            const savedCallback = useRef();
            useEffect(() => { savedCallback.current = callback; }, [callback]);
            useEffect(() => {
                if (delay !== null) {
                    const id = setInterval(() => savedCallback.current(), delay);
                    return () => clearInterval(id);
                }
            }, [delay]);
        };

        // --- 1. æ ¸å¿ƒé…ç½® ---

        const getDayPhase = () => {
            const h = new Date().getHours();
            if (h >= 5 && h < 9) return 'morning';
            if (h >= 9 && h < 17) return 'day';
            if (h >= 17 && h < 20) return 'sunset';
            return 'night';
        };

        const getPixelManState = (holdTime) => {
            if (holdTime < 20) return 'normal';
            if (holdTime < 40) return 'blush';
            if (holdTime < 70) return 'sweat';
            if (holdTime < 100) return 'steam';
            return 'nosebleed';
        };

        const PIXEL_ART_BASE = [
            0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,
            0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,
            0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,
            0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,
            0,0,0,0,1,1,1,1,1,4,1,1,1,1,1,0,0,0,0,
            0,0,0,1,1,1,1,1,1,4,1,1,1,1,1,1,0,0,0,
            0,0,1,1,1,1,1,1,1,4,1,1,1,1,1,1,1,0,0,
            0,0,1,1,1,1,1,1,1,4,1,1,1,1,1,1,1,0,0,
            0,0,1,1,1,1,1,1,1,4,1,1,1,1,1,1,1,0,0,
            0,0,0,1,1,1,1,1,1,4,1,1,1,1,1,1,0,0,0,
            0,0,0,1,1,1,3,3,3,4,3,3,3,1,1,1,0,0,0,
            0,0,0,0,1,3,3,3,3,3,3,3,3,3,1,0,0,0,0,
            0,0,0,0,2,3,3,3,3,3,3,3,3,3,2,0,0,0,0,
            0,0,0,2,2,3,3,3,0,0,0,3,3,3,2,2,0,0,0,
            0,0,2,2,2,2,2,0,0,0,0,0,2,2,2,2,2,0,
            0,2,2,2,2,2,0,0,0,0,0,0,0,2,2,2,2,2,0,
            0,2,2,2,2,0,0,0,0,0,0,0,0,0,2,2,2,2,0,
            0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0,
            0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,
            0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,
            0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,
            0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0
        ];

        const NIGHT_QUOTES = ["æ²¡äººçŸ¥é“ä½ åœ¨ç»ƒå“¦~", "è¿™ä¹ˆæ™šäº†è¿˜åœ¨å·å·åŠªåŠ›...", "å˜˜ï¼Œæ„Ÿå—è‚Œè‚‰çš„å¾‹åŠ¨", "ä»Šæ™šçš„æœˆè‰²çœŸç¾ï¼Œé€‚åˆæè‚›"];
        const POETRY_LIST = [
            "è¡Œåˆ°æ°´ç©·å¤„ï¼Œåçœ‹äº‘èµ·æ—¶ã€‚", "æ˜æœˆæ¾é—´ç…§ï¼Œæ¸…æ³‰çŸ³ä¸Šæµã€‚", "ä¸‡ç‰©é™è§‚çš†è‡ªå¾—ã€‚", "èº«ä¼¼è©ææ ‘ï¼Œå¿ƒå¦‚æ˜é•œå°ã€‚",
            "éæ·¡æ³Šæ— ä»¥æ˜å¿—ã€‚", "æ¸…é£å¾æ¥ï¼Œæ°´æ³¢ä¸å…´ã€‚", "å¿ƒè¿œåœ°è‡ªåã€‚", "é‡‡èŠä¸œç¯±ä¸‹ï¼Œæ‚ ç„¶è§å—å±±ã€‚",
            "ä¸€è“‘çƒŸé›¨ä»»å¹³ç”Ÿã€‚", "å›é¦–å‘æ¥è§ç‘Ÿå¤„ã€‚", "æœ¬æ¥æ— ä¸€ç‰©ï¼Œä½•å¤„æƒ¹å°˜åŸƒã€‚", "å® è¾±ä¸æƒŠï¼Œé—²çœ‹åº­å‰èŠ±å¼€èŠ±è½ã€‚"
        ];

        const KEGEL_QUOTES = [
            "è¿˜ä¸æè‡€ï¼Ÿè¦é•¿ç—”ç–®å•¦ï¼", "åªæœ‰è‡ªå·±çŸ¥é“çš„åŠªåŠ›ã€‚", "æ ¸å¿ƒæ”¶ç´§ï¼Œç¨³å¦‚æ³°å±±ã€‚",
            "è¿™ä¸€åˆ»çš„é…¸çˆ½ï¼Œæ˜¯ä¸ºäº†è€æ¥çš„ä½“é¢ã€‚", "åˆ«å·æ‡’ï¼Œæ‹¬çº¦è‚Œåœ¨çœ‹ç€ä½ ã€‚", "ææ°”è½»èº«ï¼Œå¦‚å±¥äº‘ç«¯ã€‚",
            "æƒ³æƒ³ä½ çš„å‰åˆ—è…ºï¼", "æ¯å¤©ä¸€ç™¾ä¸‹ï¼Œå¹¸ç¦ä½ æˆ‘ä»–ã€‚", "å¤¹ç´§ï¼è¿™æ˜¯å°Šä¸¥ä¹‹æˆ˜ï¼",
            "ä¸è¦åœï¼Œæ„Ÿå—é‚£è‚¡åŠ›é‡ï¼", "æ¾å¼›æ„Ÿæ˜¯ç•™ç»™å‘¼æ°”çš„ï¼Œè¿™é‡Œè¦ç´§ï¼", "è¿™ç‚¹é…¸éƒ½å—ä¸äº†ï¼Œæ€ä¹ˆåšå¤§äº‹ï¼Ÿ",
            "ä½ çš„ç›†åº•è‚Œåœ¨å°–å«ï¼šæ›´å¼ºï¼", "è¿™ä¸æ¯”ç©æ‰‹æœºæœ‰æ„ä¹‰ï¼Ÿ", "ä¸ºäº†ä¸‹åŠèº«çš„å¹¸ç¦ï¼Œå†²ï¼"
        ];

        const PRESETS = [
            { name: "åŠ©çœ  (4-7-8)", inhale: 4, hold: 7, exhale: 8 },
            { name: "ä¸“æ³¨ (4-4-4)", inhale: 4, hold: 4, exhale: 4 },
            { name: "å…±æŒ¯ (5-0-5)", inhale: 5, hold: 0, exhale: 5 },
        ];

        // --- 2. å­ç»„ä»¶ï¼šå‘¼å¸è®­ç»ƒ ---
        const BreathingView = ({ onBack, soundEnabled, updateStats }) => {
            const [status, setStatus] = useState('Setup'); 
            const [phase, setPhase] = useState('Ready'); 
            const [secondsLeft, setSecondsLeft] = useState(0); 
            const [selectedDuration, setSelectedDuration] = useState(5);
            const [isCustomMode, setIsCustomMode] = useState(false);
            const [customRhythm, setCustomRhythm] = useState({ inhale: 4, hold: 4, exhale: 4 });
            const [selectedPresetIndex, setSelectedPresetIndex] = useState(0);
            const [totalTime, setTotalTime] = useState(0);
            const [cycleCount, setCycleCount] = useState(0);
            const [readyCountdown, setReadyCountdown] = useState(3);
            const [poeticLine, setPoeticLine] = useState(''); 

            const { playTone } = useSound(soundEnabled);

            const activeRhythm = useMemo(() => {
                return isCustomMode ? customRhythm : PRESETS[selectedPresetIndex];
            }, [isCustomMode, customRhythm, selectedPresetIndex]);

            const refreshPoetry = () => {
                setPoeticLine(POETRY_LIST[Math.floor(Math.random() * POETRY_LIST.length)]);
            };

            // æ ¸å¿ƒå‘¼å¸å¾ªç¯
            useEffect(() => {
                if (status !== 'Active') return;

                let timer;
                const phaseDuration = activeRhythm[phase.toLowerCase()] || 4;
                setSecondsLeft(phaseDuration);

                if (phase === 'Inhale') {
                    playTone('breath_in');
                    refreshPoetry(); 
                }
                if (phase === 'Hold') playTone('tick');
                if (phase === 'Exhale') playTone('bell');

                const countdownInterval = setInterval(() => {
                    setSecondsLeft((prev) => Math.max(0, prev - 1));
                }, 1000);

                timer = setTimeout(() => {
                    if (phase === 'Inhale') {
                        setPhase(activeRhythm.hold > 0 ? 'Hold' : 'Exhale');
                    } else if (phase === 'Hold') {
                        setPhase('Exhale');
                    } else if (phase === 'Exhale') {
                        setCycleCount(c => c + 1);
                        setPhase('Inhale'); 
                        if (selectedDuration > 0 && totalTime >= selectedDuration * 60) {
                            setStatus('Summary');
                            playTone('unlock');
                        }
                    }
                }, phaseDuration * 1000);

                return () => { clearTimeout(timer); clearInterval(countdownInterval); };
            }, [phase, status, activeRhythm]);

            // å‡†å¤‡é˜¶æ®µå€’è®¡æ—¶
            useEffect(() => {
                if (status === 'Ready') {
                    if (readyCountdown > 0) {
                        const id = setTimeout(() => {
                            playTone('tick');
                            setReadyCountdown(c => c - 1);
                        }, 1000);
                        return () => clearTimeout(id);
                    } else {
                        setStatus('Active');
                        setPhase('Inhale'); 
                        setTotalTime(0);
                        setCycleCount(0);
                        refreshPoetry(); 
                    }
                }
            }, [status, readyCountdown]);

            useInterval(() => {
                if (status === 'Active') setTotalTime(t => t + 1);
            }, 1000);

            const handleStartClick = () => {
                setStatus('Ready');
                setReadyCountdown(3);
            };

            const getRingStyle = () => {
                const duration = status === 'Active' ? (activeRhythm[phase.toLowerCase()] || 4) : 0.5;
                let scale = 1, opacity = 0.5, text = "å‡†å¤‡";
                
                if (status === 'Ready') {
                    text = readyCountdown.toString();
                    scale = 1;
                    opacity = 0.8;
                } else if (status === 'Active') {
                    if (phase === 'Inhale') { scale = 1.5; opacity = 1; text = "å¸æ°”"; }
                    else if (phase === 'Hold') { scale = 1.55; opacity = 0.9; text = "å±æ°”"; }
                    else if (phase === 'Exhale') { scale = 1.0; opacity = 0.6; text = "å‘¼æ°”"; }
                }
                return { scale, opacity, duration, text };
            };
            const ring = getRingStyle();

            if (status === 'Summary') {
                return (
                    <div className="flex flex-col items-center justify-center h-full animate-fadeIn p-6">
                        <div className="bg-white/90 backdrop-blur-xl p-8 rounded-3xl shadow-2xl text-center w-full max-w-sm border border-white/50 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-teal-400 to-emerald-500"></div>
                            <Trophy className="w-16 h-16 text-yellow-500 mx-auto mb-4 animate-bounce" />
                            <h2 className="text-2xl font-bold text-slate-800 mb-2">ç»ƒä¹ å®Œæˆ</h2>
                            <div className="grid grid-cols-2 gap-4 mb-8 mt-6">
                                <div className="bg-slate-50 p-4 rounded-xl">
                                    <div className="text-2xl font-bold text-teal-600">{formatTime(totalTime)}</div>
                                    <div className="text-xs text-slate-400">æ€»æ—¶é•¿</div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl">
                                    <div className="text-2xl font-bold text-teal-600">{cycleCount}</div>
                                    <div className="text-xs text-slate-400">å‘¼å¸å¾ªç¯</div>
                                </div>
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => { updateStats(totalTime, 0); onBack(); }} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold">è¿”å›</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center w-full h-full relative">
                    <div className="w-full flex justify-between items-center mb-4 z-20">
                        <button onClick={onBack} className="p-2 bg-white/20 backdrop-blur-md rounded-full"><ArrowLeft size={20} color="#fff"/></button>
                        {status === 'Active' && (
                            <div className="px-4 py-1 bg-black/20 backdrop-blur-md rounded-full text-white text-xs font-mono">
                                {formatTime(totalTime)} {selectedDuration > 0 ? `/ ${selectedDuration}m` : ''}
                            </div>
                        )}
                        <div className="w-10"></div>
                    </div>

                    {status === 'Setup' ? (
                        <div className="w-full max-w-sm animate-fadeIn z-10 flex-1 flex flex-col">
                            <h2 className="text-3xl font-light text-white mb-6 text-center drop-shadow-md">å‘¼å¸è®¾å®š</h2>
                            <div className="mb-6">
                                <p className="text-white/90 text-sm mb-3 font-bold ml-1 flex items-center gap-2"><Clock size={14}/> ç›®æ ‡æ—¶é•¿</p>
                                <div className="grid grid-cols-4 gap-3">
                                    {[5, 10, 15, 0].map(m => (
                                        <button key={m} onClick={() => setSelectedDuration(m)} 
                                            className={`aspect-square rounded-2xl border transition-all flex flex-col items-center justify-center text-white 
                                            ${selectedDuration === m ? 'bg-white/40 border-white shadow-lg scale-105' : 'bg-white/10 border-white/20 hover:bg-white/20'}`}>
                                            <span className="text-xl font-bold">{m === 0 ? 'âˆ' : m}</span>
                                            <span className="text-[10px]">{m === 0 ? 'æ— é™' : 'åˆ†é’Ÿ'}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-white/90 backdrop-blur-xl rounded-3xl p-5 shadow-xl mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <p className="text-slate-700 font-bold flex items-center gap-2 text-sm"><Settings size={16}/> å‘¼å¸èŠ‚å¥</p>
                                    <div className="flex bg-slate-100 rounded-lg p-1">
                                        <button onClick={() => setIsCustomMode(false)} className={`px-3 py-1 text-xs rounded-md transition-all ${!isCustomMode ? 'bg-white shadow text-teal-600 font-bold' : 'text-slate-400'}`}>é¢„è®¾</button>
                                        <button onClick={() => setIsCustomMode(true)} className={`px-3 py-1 text-xs rounded-md transition-all ${isCustomMode ? 'bg-white shadow text-teal-600 font-bold' : 'text-slate-400'}`}>è‡ªå®šä¹‰</button>
                                    </div>
                                </div>
                                {isCustomMode ? (
                                    <div className="space-y-4">
                                        {['inhale', 'hold', 'exhale'].map(key => (
                                            <div key={key} className="flex items-center gap-3">
                                                <span className="text-xs text-slate-500 w-8 capitalize font-bold">{key === 'inhale' ? 'å¸' : key === 'hold' ? 'å±' : 'å‘¼'}</span>
                                                <input type="range" min="0" max="15" step="1" 
                                                    value={customRhythm[key]} 
                                                    onChange={(e) => setCustomRhythm(prev => ({...prev, [key]: parseInt(e.target.value)}))} 
                                                    className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-teal-500"/>
                                                <span className="text-xs font-mono font-bold w-6 text-right text-teal-600">{customRhythm[key]}s</span>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 gap-2">
                                        {PRESETS.map((p, i) => (
                                            <button key={i} onClick={() => setSelectedPresetIndex(i)}
                                                className={`p-3 rounded-xl text-left transition-all border group relative
                                                ${selectedPresetIndex === i ? 'bg-teal-50 border-teal-200 ring-1 ring-teal-200' : 'bg-slate-50 border-slate-100 hover:bg-white'}`}>
                                                <div className={`font-bold text-sm ${selectedPresetIndex === i ? 'text-teal-700' : 'text-slate-600'}`}>{p.name}</div>
                                                <div className="text-[10px] text-slate-400 mt-1">{p.inhale}s å¸ - {p.hold}s å± - {p.exhale}s å‘¼</div>
                                                {selectedPresetIndex === i && <div className="absolute right-3 top-3 w-2 h-2 bg-teal-500 rounded-full animate-pulse"></div>}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <div className="mt-auto">
                                <button onClick={handleStartClick} className="w-full py-4 bg-gradient-to-r from-teal-400 to-emerald-500 hover:shadow-lg hover:shadow-teal-300/50 text-white rounded-2xl font-bold text-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                                    <Play fill="currentColor" size={20}/> å¼€å§‹ç»ƒä¹ 
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col items-center justify-center relative w-full z-10 animate-fadeIn">
                            <div className="relative w-80 h-80 flex items-center justify-center">
                                <div className={`absolute inset-0 bg-teal-500/20 rounded-full blur-[60px] transition-all duration-1000 ${status === 'Active' ? 'opacity-100 animate-pulse' : 'opacity-0'}`}></div>
                                
                                <div className="w-64 h-64 rounded-full border-4 border-teal-600/30 bg-teal-600/10 backdrop-blur-sm flex items-center justify-center transition-all ease-in-out relative will-change-transform"
                                     style={{ 
                                         transform: `scale(${ring.scale})`, 
                                         opacity: ring.opacity,
                                         transitionDuration: `${ring.duration}s`
                                     }}>
                                     <div className="absolute inset-0 bg-white/10 rounded-full blur-md"></div>
                                </div>
                                
                                <div className="absolute inset-0 flex flex-col items-center justify-center text-teal-900 drop-shadow-sm pointer-events-none">
                                    <span className="text-2xl font-light tracking-widest mb-2 transition-all">{ring.text}</span>
                                    {status === 'Active' && secondsLeft > 0 && (
                                        <span className="text-6xl font-bold font-mono animate-in fade-in zoom-in duration-300 key={secondsLeft}">
                                            {secondsLeft}
                                        </span>
                                    )}
                                </div>
                            </div>

                            <div className="h-16 flex flex-col items-center justify-center mt-8 mb-8 w-full px-6 text-center">
                                {poeticLine && status === 'Active' ? (
                                    <p className="text-teal-900 font-serif italic text-lg animate-fadeIn font-bold" style={{textShadow: "0 1px 2px rgba(255,255,255,0.8)"}}>{poeticLine}</p>
                                ) : (
                                    <p className="text-slate-500 text-sm">è·ŸéšèŠ‚å¥å‘¼å¸</p>
                                )}
                            </div>

                            <div className="w-full px-8">
                                 <button onClick={() => setStatus('Summary')} className="w-full py-3 bg-white/40 hover:bg-white/60 backdrop-blur-md rounded-2xl text-teal-900 font-bold border border-white/40 transition-all active:scale-95 shadow-sm">
                                     ç»“æŸç»ƒä¹ 
                                 </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 3. å­ç»„ä»¶ï¼šKegel è®­ç»ƒ ---
        const KegelView = ({ onBack, soundEnabled, updateStats }) => {
            const [mode, setMode] = useState('auto'); 
            const [isTensing, setIsTensing] = useState(false);
            const [holdTime, setHoldTime] = useState(0); 
            const [maxHoldTime, setMaxHoldTime] = useState(0); 
            const [totalHoldSeconds, setTotalHoldSeconds] = useState(0);
            const [autoTimer, setAutoTimer] = useState(3);
            const [autoPhase, setAutoPhase] = useState('relax'); 
            const [motivationalQuote, setMotivationalQuote] = useState(''); 

            const { playTone } = useSound(soundEnabled);
            const dayPhase = getDayPhase();
            const pixelState = getPixelManState(mode === 'manual' ? holdTime : (autoPhase === 'tense' ? autoTimer : 0));
            const isNight = dayPhase === 'night';

            useInterval(() => {
                if (mode === 'manual' && isTensing) {
                    setHoldTime(t => {
                        const newT = t + 0.1;
                        if (newT > maxHoldTime) setMaxHoldTime(newT);
                        return newT;
                    });
                    setTotalHoldSeconds(t => t + 0.1);
                }
            }, 100);

            useEffect(() => {
                if (mode !== 'auto') return;
                let interval;
                if (isTensing) { 
                     interval = setInterval(() => {
                        setAutoTimer(prev => {
                            if (prev <= 1) {
                                const nextPhase = autoPhase === 'relax' ? 'tense' : 'relax';
                                setAutoPhase(nextPhase);
                                if (nextPhase === 'tense') {
                                    playTone('tick');
                                    if(window.navigator.vibrate) window.navigator.vibrate([80]);
                                    setMotivationalQuote(KEGEL_QUOTES[Math.floor(Math.random() * KEGEL_QUOTES.length)]);
                                    return 5; 
                                } else {
                                    playTone('bell');
                                    return 5; 
                                }
                            }
                            if (autoPhase === 'tense') setTotalHoldSeconds(t => t + 1);
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [mode, isTensing, autoPhase]);

            useEffect(() => () => updateStats(0, Math.floor(totalHoldSeconds)), []);

            const renderPixelMan = () => {
                return (
                    <div className="grid grid-cols-[repeat(19,minmax(0,1fr))] gap-[2px] relative z-10">
                        {PIXEL_ART_BASE.map((val, idx) => {
                            let bg = 'bg-transparent';
                            let transform = 'translate-y-0 scale-100';
                            let transition = 'transition-all duration-1000 ease-in-out';
                            
                            const active = (mode === 'manual' && isTensing) || (mode === 'auto' && autoPhase === 'tense');

                            if (val === 1) { bg = 'bg-slate-700/80'; if (!active) transform = 'translate-y-[1px]'; }
                            if (val === 4) bg = 'bg-slate-800'; 
                            if (val === 2) bg = 'bg-slate-700/80'; 
                            if (val === 3) { 
                                bg = active ? 'bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.8)]' : 'bg-slate-600';
                                transform = active ? 'translate-y-[-2px] scale-90' : 'translate-y-[1px]';
                            }

                            if (pixelState !== 'normal' && [48, 49, 67, 68].includes(idx)) bg = 'bg-pink-400/80'; 
                            if (pixelState === 'nosebleed' && [86, 105].includes(idx)) { 
                                bg = 'bg-red-600 animate-pulse'; 
                                transform = 'translate-y-[10px]'; 
                            }
                            
                            if (val === 0) {
                                if (pixelState === 'steam' && idx < 40 && Math.random() > 0.8) {
                                    return <div key={idx} className="w-2 h-2 rounded-full bg-white/40 animate-ping"></div>
                                }
                                return <div key={idx} className="w-2 h-2 sm:w-3 sm:h-3"></div>;
                            }

                            return <div key={idx} className={`w-2 h-2 sm:w-3 sm:h-3 rounded-[1px] ${transition} ${bg} ${transform}`}></div>;
                        })}
                    </div>
                );
            };

            return (
                <div className="flex flex-col items-center w-full h-full relative text-slate-800">
                     <div className="w-full flex justify-between items-center mb-6 z-20">
                        <button onClick={() => { updateStats(0, Math.floor(totalHoldSeconds)); onBack(); }} className="p-2 bg-white/50 backdrop-blur-md rounded-full"><ArrowLeft size={20}/></button>
                        <div className="bg-black/20 backdrop-blur-md px-4 py-1 rounded-full text-white text-xs">
                            <span className="font-bold">{mode === 'manual' ? 'æ‰‹åŠ¨æ¨¡å¼' : 'è‡ªåŠ¨å¾ªç¯'}</span>
                            <span className="mx-2">|</span>
                            <Zap size={10} className="inline mr-1"/>{Math.floor(totalHoldSeconds)}s
                        </div>
                        <div className="w-10"></div>
                    </div>

                    <div className="flex bg-black/10 backdrop-blur-md p-1 rounded-2xl mb-6 relative z-10">
                        <button onClick={() => {setMode('auto'); setIsTensing(false);}} className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${mode === 'auto' ? 'bg-white shadow-md text-teal-600' : 'text-white/70'}`}>è‡ªåŠ¨è·Ÿç»ƒ</button>
                        <button onClick={() => {setMode('manual'); setIsTensing(false);}} className={`px-6 py-2 rounded-xl text-sm font-bold transition-all ${mode === 'manual' ? 'bg-white shadow-md text-rose-500' : 'text-white/70'}`}>é•¿æŒ‰æŒ‘æˆ˜</button>
                    </div>

                    <div className={`bg-white/40 backdrop-blur-xl p-8 rounded-[3rem] shadow-2xl border border-white/50 mb-4 w-full max-w-[340px] flex flex-col items-center relative overflow-hidden transition-all duration-500 ${isTensing ? 'scale-105 shadow-rose-400/50' : ''}`}>
                         <div className={`absolute inset-0 transition-opacity duration-1000 opacity-40 bg-gradient-to-t ${isTensing ? 'from-rose-300 via-rose-100 to-transparent' : 'from-slate-200 to-transparent'}`}></div>
                         
                         {renderPixelMan()}

                         <div className="mt-6 text-center z-10 h-16">
                             {mode === 'auto' ? (
                                 <>
                                     <div className={`text-3xl font-black ${autoPhase === 'tense' ? 'text-rose-600' : 'text-slate-500'}`}>
                                         {autoPhase === 'tense' ? 'æ”¶ç¼© (æ)' : 'æ”¾æ¾ (æ¾)'}
                                     </div>
                                     <div className="text-sm font-mono mt-1 text-slate-500">{autoTimer}s</div>
                                 </>
                             ) : (
                                 <>
                                     <div className={`text-3xl font-black ${isTensing ? 'text-rose-600' : 'text-slate-500'}`}>
                                         {isTensing ? 'ä¿æŒä½ï¼' : 'æŒ‰ä½å¼€å§‹'}
                                     </div>
                                     <div className="text-sm font-mono mt-1 text-rose-500 font-bold">{holdTime.toFixed(1)}s</div>
                                 </>
                             )}
                         </div>
                    </div>

                    <div className="h-12 w-full flex items-center justify-center mb-4 z-10 px-4">
                         {motivationalQuote && (
                             <p className="text-rose-600 font-bold text-sm animate-bounce text-center drop-shadow-sm bg-white/30 backdrop-blur-sm px-3 py-1 rounded-full border border-rose-100">
                                 â€œ{motivationalQuote}â€
                             </p>
                         )}
                    </div>

                    <div className="w-full px-6 z-10">
                        {mode === 'auto' ? (
                            <button onClick={() => {
                                setIsTensing(!isTensing);
                                if(!isTensing) setMotivationalQuote(KEGEL_QUOTES[Math.floor(Math.random() * KEGEL_QUOTES.length)]);
                            }} className={`w-full py-4 rounded-2xl font-bold text-lg shadow-xl transition-all active:scale-95 ${isTensing ? 'bg-white text-slate-600' : 'bg-rose-500 text-white shadow-rose-400/50'}`}>
                                {isTensing ? 'æš‚åœ' : 'å¼€å§‹å¾ªç¯'}
                            </button>
                        ) : (
                            <button 
                                onMouseDown={() => { setIsTensing(true); setMotivationalQuote(KEGEL_QUOTES[Math.floor(Math.random() * KEGEL_QUOTES.length)]); }} 
                                onMouseUp={() => setIsTensing(false)}
                                onTouchStart={(e) => { e.preventDefault(); setIsTensing(true); setMotivationalQuote(KEGEL_QUOTES[Math.floor(Math.random() * KEGEL_QUOTES.length)]); }} 
                                onTouchEnd={(e) => { e.preventDefault(); setIsTensing(false); }}
                                className={`w-full py-6 rounded-2xl font-black text-xl shadow-xl transition-all select-none touch-none ${isTensing ? 'bg-rose-600 scale-95 shadow-inner ring-4 ring-rose-200' : 'bg-rose-500 text-white shadow-rose-400/50 animate-pulse'}`}>
                                {isTensing ? 'ğŸ”¥ åšæŒä¸­...' : 'é•¿æŒ‰æè‚› (Hold)'}
                            </button>
                        )}
                    </div>

                    {isNight && (
                        <div className="mt-6 bg-indigo-900/30 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 animate-fadeIn">
                            <p className="text-indigo-100 text-xs italic">ğŸŒ™ {NIGHT_QUOTES[Math.floor(Math.random() * NIGHT_QUOTES.length)]}</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- 4. ä¸»å…¥å£ ---
        const App = () => {
            const [view, setView] = useState('menu');
            const [soundEnabled, setSoundEnabled] = useState(false);
            
            const [stats, setStats] = useLocalStorage('health_stats_v3', { 
                totalMinutes: 0, 
                totalHoldSeconds: 0,
                streak: 0, 
                lastDate: null 
            });

            const updateStats = (breathSecs, kegelSecs) => {
                const today = new Date().toDateString();
                const breathMins = Math.floor(breathSecs / 60);
                
                setStats(prev => {
                    let newStreak = prev.streak;
                    if (prev.lastDate !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (prev.lastDate === yesterday.toDateString()) newStreak += 1;
                        else if (prev.lastDate !== today) newStreak = 1;
                    }
                    return {
                        ...prev,
                        totalMinutes: prev.totalMinutes + breathMins,
                        totalHoldSeconds: prev.totalHoldSeconds + kegelSecs,
                        streak: newStreak,
                        lastDate: today
                    };
                });
            };

            const getBgClass = () => {
                const h = new Date().getHours();
                if (h >= 23 || h < 6) return "from-slate-900 via-indigo-950 to-black"; 
                if (h >= 6 && h < 9) return "from-orange-200 via-rose-200 to-blue-200"; 
                if (h >= 17 && h < 20) return "from-indigo-400 via-purple-400 to-orange-300"; 
                if (view === 'breath') return "from-teal-100 via-emerald-100 to-cyan-50";
                if (view === 'kegel') return "from-rose-50 via-pink-100 to-indigo-100";
                return "from-blue-50 via-indigo-50 to-white";
            };

            return (
                <div className={`flex flex-col items-center justify-center min-h-screen font-sans transition-all duration-[2000ms] bg-gradient-to-br ${getBgClass()} overflow-hidden text-slate-800`}>
                     <div className="absolute inset-0 pointer-events-none opacity-30" style={{backgroundImage: "url('https://www.transparenttextures.com/patterns/stardust.png')"}}></div>

                    <div className="w-full max-w-md relative z-10 min-h-screen flex flex-col p-6">
                        {view === 'menu' && (
                            <div className="flex-1 flex flex-col justify-center animate-fadeIn">
                                <div className="flex justify-between items-center mb-8 bg-white/40 backdrop-blur-md p-2 pl-4 rounded-full shadow-sm border border-white/40">
                                    <div className="flex items-center gap-2 text-sm font-bold text-slate-700">
                                        <Flame className="text-orange-500 fill-orange-500" size={18}/> 
                                        å·²è¿ç»­ {stats.streak} å¤©
                                    </div>
                                    <div className="bg-white/50 px-3 py-1 rounded-full text-xs text-slate-500">Lv.{Math.floor(stats.streak / 7) + 1}</div>
                                </div>

                                <header className="mb-10 text-center">
                                    <h1 className="text-4xl font-extralight tracking-wider mb-2 text-slate-800 drop-shadow-sm">èº«å¿ƒç–—æ„ˆç«™</h1>
                                    <p className="text-slate-500 text-xs tracking-[0.3em] uppercase">Mind & Body Sanctuary</p>
                                </header>

                                <div className="grid gap-5">
                                    <button onClick={() => setView('breath')} className="group relative overflow-hidden bg-white/60 backdrop-blur-xl p-6 rounded-[2rem] shadow-lg hover:shadow-xl transition-all border border-white/60 text-left hover:-translate-y-1">
                                        <div className="absolute right-0 top-0 bottom-0 w-32 bg-gradient-to-l from-teal-100/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <div className="flex justify-between items-start mb-4 relative z-10">
                                            <div className="p-4 bg-teal-50 rounded-2xl text-teal-600 shadow-inner group-hover:scale-110 transition-transform"><Wind size={28} /></div>
                                            <span className="text-[10px] font-bold text-white bg-teal-400 px-3 py-1 rounded-full shadow-md shadow-teal-200">ç›®æ ‡æ¨¡å¼ New</span>
                                        </div>
                                        <h2 className="text-2xl font-bold text-slate-700 mb-1">å†¥æƒ³å‘¼å¸</h2>
                                        <p className="text-xs text-slate-400">è‡ªå®šä¹‰èŠ‚å¥ Â· æ·±åº¦æ”¾æ¾</p>
                                    </button>

                                    <button onClick={() => setView('kegel')} className="group relative overflow-hidden bg-white/60 backdrop-blur-xl p-6 rounded-[2rem] shadow-lg hover:shadow-xl transition-all border border-white/60 text-left hover:-translate-y-1">
                                        <div className="absolute right-0 top-0 bottom-0 w-32 bg-gradient-to-l from-rose-100/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <div className="flex justify-between items-start mb-4 relative z-10">
                                            <div className="p-4 bg-rose-50 rounded-2xl text-rose-500 shadow-inner group-hover:scale-110 transition-transform"><Activity size={28} /></div>
                                            <span className="text-[10px] font-bold text-white bg-rose-400 px-3 py-1 rounded-full shadow-md shadow-rose-200">æ‰‹åŠ¨æ¨¡å¼ Hot</span>
                                        </div>
                                        <h2 className="text-2xl font-bold text-slate-700 mb-1">ç›†åº•è‚Œè®­ç»ƒ</h2>
                                        <p className="text-xs text-slate-400">å°äººè¿›åŒ– Â· æ ¸å¿ƒæ¿€æ´»</p>
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 mt-8">
                                     <div className="bg-white/30 backdrop-blur-sm p-4 rounded-2xl border border-white/30 flex flex-col items-center">
                                         <div className="text-2xl font-bold text-slate-700">{stats.totalMinutes}</div>
                                         <div className="text-[10px] text-slate-500 uppercase">å‘¼å¸(åˆ†)</div>
                                     </div>
                                     <div className="bg-white/30 backdrop-blur-sm p-4 rounded-2xl border border-white/30 flex flex-col items-center">
                                         <div className="text-2xl font-bold text-slate-700">{stats.totalHoldSeconds}</div>
                                         <div className="text-[10px] text-slate-500 uppercase">æè‚›(ç§’)</div>
                                     </div>
                                </div>

                                <div className="mt-8 flex justify-center">
                                    <button onClick={() => setSoundEnabled(!soundEnabled)} className={`flex items-center gap-2 px-5 py-2 rounded-full text-xs font-bold transition-colors shadow-sm ${soundEnabled ? 'bg-indigo-500 text-white' : 'bg-slate-200 text-slate-500'}`}>
                                        {soundEnabled ? <Volume2 size={14}/> : <VolumeX size={14}/>}
                                        {soundEnabled ? "éŸ³æ•ˆå¼€å¯" : "é™éŸ³æ¨¡å¼"}
                                    </button>
                                </div>
                            </div>
                        )}

                        {view === 'breath' && <BreathingView onBack={() => setView('menu')} soundEnabled={soundEnabled} updateStats={updateStats} />}
                        {view === 'kegel' && <KegelView onBack={() => setView('menu')} soundEnabled={soundEnabled} updateStats={updateStats} />}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>